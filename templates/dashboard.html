<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Event Cards Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>
<body>
  <!-- Top Navigation Bar -->
  <div class="topnav">
    <a href="#" class="no-link">Argus</a>
    <div class="topnav-right">
      <a class="nav-link" href="#Dashboard">Dashboard</a>
      <a class="nav-link" href="#Alerts">Alerts</a>
      <a class="nav-link logout-link" href="{{ url_for('logout') }}">Logout</a>
      <button id="theme-toggle" class="theme-btn">ðŸŒ™</button>
    </div>
  </div>

  <!-- Dashboard Grid Layout -->
  <div class="dashboard-grid">
    <!-- Left Column -->
    <div class="main-wrapper">
      <div class="dashboard">
        <div class="card1">
          <div class="card-title">ALL<br>EVENTS</div>
          <div class="card-number" id="event-count">Loading...</div>
        </div>        
        <div class="card2">
          <div class="card-title">WINDOW<br>EVENTS</div>
          <div class="card-number">0</div>
          <div class="all-window"><a href="allwindows.html">view all</a></div>
        </div>
        <div class="card3">
          <div class="card-title">SYSLOG<br>EVENTS</div>
          <div class="card-number">53</div>
          <div class="all-syslog"><a href="allsyslogs.html">view all</a></div>
        </div>
        <div class="card4">
          <div class="card-title">ALL<br>DEVICES</div>
          <div class="card-number">4</div>
          <div class="all-devices"><a href="alldevices.html">view all</a></div>
        </div>
      </div>

      <!-- CPU + Ports Card -->
      <div class="container">
        <div class="card">
          <div class="left-section">
            <h3>WINSPC-01</h3>
            <span>CPU Health</span>
          </div>
          <div class="circle-wrap">
            <svg viewBox="0 0 100 100" width="100" height="100">
              <circle class="circle-bg" cx="50" cy="50" r="44"></circle>
              <circle class="circle-progress" cx="50" cy="50" r="44" style="stroke-dashoffset:276;"></circle>
            </svg>            
            <div class="circle-text">92%</div>
          </div>
        </div>

        <div class="card">
          <div class="left-section">
            <h3>WINSPC-01</h3>
            <span>SSH</span><br>
            <span>Telnet</span><br>
            <span>HTTP</span><br>
            <span>FTP</span>
          </div>
          <div class="right-section" id="open-ports-box">
            <h3>Open Ports</h3>
            <span>Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Recent Alerts -->
    <div class="security-logs">
      <div class="right-dashboard">
        <h1 class="dashboard-title">Recent Alerts</h1>
        <p class="last-updated">Last Updated Time: <span id="lastUpdatedTime"></span></p>
        <div id="alerts" class="alerts-container"></div>
      </div>
    </div>
  </div>

  <!-- Alerts Table Section -->
  <div class="container" id="Alerts">
    <div class="table-header">
      <h2>All Alerts</h2>
      <input type="text" placeholder="Search logs..." class="search-input" id="searchInput">
    </div>
    <table id="logsTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Details</th>
          <th>Classification</th>
          <th>Source IP</th>
          <th>Destination IP</th>
          <th>Device Name</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Charts Section -->
  <div id="charts-and-chat">
    <div style="width: 100%;">
      <h2>Alerts Over Time</h2>
      <canvas id="lineChart" width="600" height="250"></canvas>
    </div>
    <div style="width: 100%;">
      <h2>Severity Breakdown</h2>
      <canvas id="pieChart" width="600" height="250"></canvas>
    </div>
  </div>

  <!-- Floating Chat Button -->
  <button id="chat-button">ðŸ’¬</button>

  <!-- Chat Popup -->
  <div id="chat-window">
    <div id="chatbox"></div>
    <div id="chat-input-container">
      <input type="text" id="chatInput" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    function getSeverityColor(classification) {
      return classification.toLowerCase().includes("generic protocol command decode") ? "green" : "red";
    }

    function updateAlerts(logs) {
      const alertsContainer = document.getElementById("alerts");
      alertsContainer.innerHTML = "";
      logs.forEach(log => {
        alertsContainer.innerHTML += `
          <div class="alert-box">
            <div class="alert-text">
              <p class="alert-title">${log.classification}</p>
              <p class="alert-time">${log.timestamp}</p>
            </div>
            <div class="alert-status" style="background-color: ${getSeverityColor(log.classification)};"></div>
          </div>`;
      });
      document.getElementById("lastUpdatedTime").textContent = new Date().toLocaleString();
    }

    function updateLineChart() {
      fetch('/api/alerts-over-time')
        .then(res => res.json())
        .then(data => {
          const ctx = document.getElementById('lineChart').getContext('2d');
          if (window.lineChart) window.lineChart.destroy();
          window.lineChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.timestamps,
              datasets: [{
                label: "Alerts Over Time",
                data: data.alerts,
                borderColor: 'red',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
              }]
            }
          });
        });
    }

    function updatePieChart() {
      fetch('/api/severity-breakdown')
        .then(res => res.json())
        .then(data => {
          const ctx = document.getElementById('pieChart').getContext('2d');
          if (window.pieChart) window.pieChart.destroy();
          window.pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: data.labels,
              datasets: [{
                data: data.percentages,
                backgroundColor: ['#FF5733', '#33FF57', '#3357FF', '#FF33A6', '#33FFF5'],
                borderColor: '#fff',
                borderWidth: 1
              }]
            }
          });
        });
    }

    function updateOpenPorts() {
      fetch('/api/ports')
        .then(res => res.json())
        .then(data => {
          const box = document.getElementById("open-ports-box");
          box.innerHTML = "<h3>Open Ports</h3>";
          data.forEach(port => box.innerHTML += `<span>Port ${port}</span><br>`);
        });
    }

    function fetchLogs() {
      fetch('/api/logs')
        .then(res => res.json())
        .then(logs => {
          updateAlerts(logs);
          const tableBody = document.querySelector('#logsTable tbody');
          tableBody.innerHTML = "";
          logs.forEach(log => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${log.timestamp}</td>
              <td>${log.details}</td>
              <td>${log.classification}</td>
              <td>${log.src_ip}</td>
              <td>${log.dest_ip}</td>
              <td>${log.device_name}</td>`;
            tableBody.appendChild(row);
          });
        });
    }

    function sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value.trim();
      if (!message) return;
      const chatbox = document.getElementById("chatbox");
      chatbox.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
      input.value = "";
      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      })
      .then(res => res.json())
      .then(data => {
        chatbox.innerHTML += `<div><strong>Argus Sentinel:</strong> ${data.response}</div>`;
        chatbox.scrollTop = chatbox.scrollHeight;
      });
    }

    function updateCPUHealth() {
      fetch('/api/cpu')
        .then(res => res.json())
        .then(data => {
          const usage = Math.round(data.cpu);
          document.querySelector(".circle-text").textContent = `${usage}%`;
          document.querySelector(".circle-progress").style.strokeDashoffset = 276 - (276 * usage / 100);
        });
    }

    function updateEventCount() {
      fetch('/api/event-count')
        .then(res => res.json())
        .then(data => {
          document.getElementById("event-count").textContent = data.count;
        });
    }

    // Socket & Refresh
    const socket = io();
    socket.on("update_charts", () => {
      updateLineChart();
      updatePieChart();
      fetchLogs();
      updateOpenPorts();
    });

    updateLineChart();
    updatePieChart();
    fetchLogs();
    updateOpenPorts();
    updateCPUHealth();
    updateEventCount();

    setInterval(fetchLogs, 5000);
    setInterval(updateOpenPorts, 5000);
    setInterval(updateEventCount, 5000);
    setInterval(updateCPUHealth, 5000);

    // Theme
    document.addEventListener('DOMContentLoaded', () => {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark') {
        document.body.classList.add('dark');
        document.getElementById('theme-toggle').textContent = 'ðŸŒž';
      }
    });

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      document.getElementById('theme-toggle').textContent = isDark ? 'ðŸŒž' : 'ðŸŒ™';
    });

    document.getElementById("chat-button").addEventListener("click", () => {
      document.getElementById("chat-window").classList.toggle("open");
    });

    document.getElementById("searchInput").addEventListener("keyup", function () {
      const query = this.value.toLowerCase();
      const rows = document.querySelectorAll("#logsTable tbody tr");
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(query) ? "" : "none";
      });
    });
  </script>
</body>
</html>
