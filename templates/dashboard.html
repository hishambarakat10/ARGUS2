<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Cards Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <!-- Load Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Load Socket.io for real-time updates -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
</head>
<body>
  <!-- Top Navigation Bar -->
  <div class="topnav">
    <a href="#" class="no-link">Argus</a>
    <div class="topnav-right">
        <a class="nav-link" href="#Dashboard">Dashboard</a>
        <a class="nav-link" href="#Alerts">Alerts</a>
        <a class="nav-link" href="#Settings">Settings</a>
        <!-- Logout Button -->
        <a class="nav-link logout-link" href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>

  <!-- This container is for your main content (security logs, event cards, etc.) -->
  <div class="security-logs">
    <!-- Right side for Security Logs -->
    <div class="right-dashboard">
      <h1 class="dashboard-title">Recent Alerts</h1>
      <p class="last-updated">Last Updated Time: <span id="lastUpdatedTime"></span></p>
      <div id="alerts" class="alerts-container"></div>
    </div>
  </div>

  <!-- Existing main wrapper for your event cards -->
  <div class="main-wrapper">
    <div class="dashboard">
      <div class="card1">
        <div class="card-title">ALL<br>EVENTS</div>
        <div class="card-number">7842</div>
      </div>
      <div class="card2">
        <div class="card-title">WINDOW<br>EVENTS</div>
        <div class="card-number">0</div>
        <div class="all-window"><a href="allwindows.html">view all</a></div>
      </div>
      <div class="card3">
        <div class="card-title">SYSLOG<br>EVENTS</div>
        <div class="card-number">53</div>
        <div class="all-syslog"><a href="allsyslogs.html">view all</a></div>
      </div>
      <div class="card4">
        <div class="card-title">ALL<br>DEVICES</div>
        <div class="card-number">4</div>
        <div class="all-devices"><a href="alldevices.html">view all</a></div>
      </div>
    </div>
  
    <div class="container">
      <div class="card">
        <div class="left-section">
          <h3>WINSPC-01</h3>
          <span>CPU Health</span>
        </div>
        <div class="circle-wrap">
          <svg viewBox="0 0 100 100">
            <circle class="circle-bg" cx="50" cy="50" r="44"></circle>
            <circle class="circle-progress" cx="50" cy="50" r="44"></circle>
          </svg>
          <div class="circle-text">92%</div>
        </div>
      </div>
  
      <div class="card">
        <div class="left-section">
          <h3>WINSPC-01</h3>
          <span>SSH</span>
          <span>Telnet</span>
          <span>HTTP</span>
          <span>FTP</span>
        </div>
        <div class="right-section">
          <h3>OPEN PORTS</h3>
          <span>Port 22</span>
          <span>Port 23</span>
          <span>Port 80</span>
          <span>Port 21</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== ADD YOUR CHARTS & CHAT SECTION AT THE BOTTOM ================== -->
  <div id="charts-and-chat" style="display: flex; flex-direction: column; align-items: center; gap: 30px; margin: 40px 0;">
    <!-- Line Chart Section -->
    <div style="width: 600px; height: 300px; margin-bottom: 30px;">
      <h2>Alerts Over Time (Line Chart)</h2>
      <canvas id="lineChart"></canvas>
    </div>

    <!-- Pie Chart Section -->
    <div style="width: 600px; height: 300px; margin-bottom: 30px;">
      <h2>Severity Breakdown (Pie Chart)</h2>
      <canvas id="pieChart"></canvas>
    </div>

    <!-- Chatbot Section -->
    <div style="width: 400px; height: 300px;">
      <h2>Chat with AI</h2>
      <div id="chatbox" style="border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px; margin-bottom: 10px;"></div>
      <input type="text" id="chatInput" placeholder="Type a message..." style="width: 80%;">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
  <!-- =============================================================================== -->

  <!-- Scripts to handle logs, charts, and chat -->
  <script>
    // Fetch Logs for "Recent Alerts"
    function fetchLogs() {
      fetch('/api/logs')
        .then(response => response.json())
        .then(logs => updateAlerts(logs));
    }

    function updateAlerts(logs) {
      const alertsContainer = document.getElementById("alerts");
      alertsContainer.innerHTML = "";

      logs.forEach(log => {
        const severityColor = getSeverityColor(log.classification);
        const alertHTML = `
          <div class="alert-box">
            <div class="alert-text">
              <p class="alert-title">${log.classification}</p>
              <p class="alert-time">${log.timestamp}</p>
            </div>
            <div class="alert-status" style="background-color: ${severityColor};"></div>
          </div>
        `;
        alertsContainer.innerHTML += alertHTML;
      });

      document.getElementById("lastUpdatedTime").textContent = new Date().toLocaleString();
    }

    function getSeverityColor(classification) {
      // Example classification-based coloring:
      if (classification.toLowerCase().includes("malicious")) return "red";
      if (classification.toLowerCase().includes("suspicious")) return "orange";
      return "green"; // default
    }

    setInterval(fetchLogs, 5000);

    // Charts & Chat from the original dashboard code
    let lineChart, pieChart;

    // Function to update the line chart using data from /api/alerts-over-time
    function updateLineChart() {
      fetch('/api/alerts-over-time')
        .then(response => response.json())
        .then(data => {
          const lineCtx = document.getElementById('lineChart').getContext('2d');
          if (lineChart) lineChart.destroy();
          lineChart = new Chart(lineCtx, {
            type: 'line',
            data: {
              labels: data.timestamps,
              datasets: [{
                label: "Alerts Over Time",
                data: data.alerts,
                fill: false,
                borderColor: 'red'
              }]
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true } }
            }
          });
        })
        .catch(error => console.error("Error fetching line chart data:", error));
    }

    // Function to update the pie chart using data from /api/severity-breakdown
    function updatePieChart() {
      fetch('/api/severity-breakdown')
        .then(response => response.json())
        .then(data => {
          console.log("Pie chart data received:", data);
          const pieCtx = document.getElementById('pieChart').getContext('2d');
          if (pieChart) pieChart.destroy();
          pieChart = new Chart(pieCtx, {
            type: 'pie',
            data: {
              labels: data.labels,
              datasets: [{
                data: data.percentages,
                backgroundColor: ['#FF5733', '#33FF57', '#3357FF', '#FF33A6', '#33FFF5'],
                borderColor: '#fff',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        })
        .catch(error => console.error("Error fetching pie chart data:", error));
    }

    // Function to handle chat messages
    function sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value;
      if (message.trim() === "") return;
      const chatbox = document.getElementById("chatbox");
      chatbox.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
      input.value = "";
      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
      })
      .then(response => response.json())
      .then(data => {
        chatbox.innerHTML += `<div><strong>Rasa:</strong> ${data.response}</div>`;
        chatbox.scrollTop = chatbox.scrollHeight;
      })
      .catch(error => console.error("Error sending chat message:", error));
    }

    // Socket for real-time chart updates
    const socket = io();
    socket.on("update_charts", function() {
      updateLineChart();
      updatePieChart();
    });

    // Initial loads
    fetchLogs();
    updateLineChart();
    updatePieChart();
  </script>
</body>
</html>
