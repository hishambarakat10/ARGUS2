<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suricata Dashboard</title>
  <!-- Load Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Load Socket.io for real-time updates -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
</head>
<body>
  <!-- Line Chart Section -->
  <div style="width: 600px; height: 300px; margin-bottom: 30px;">
    <h2>Alerts Over Time (Line Chart)</h2>
    <canvas id="lineChart"></canvas>
  </div>

  <!-- Pie Chart Section -->
  <div style="width: 600px; height: 300px; margin-bottom: 30px;">
    <h2>Severity Breakdown (Pie Chart)</h2>
    <canvas id="pieChart"></canvas>
  </div>

  <!-- Chatbot Section -->
  <div style="width: 400px; height: 300px;">
    <h2>Chat with AI</h2>
    <div id="chatbox" style="border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px; margin-bottom: 10px;"></div>
    <input type="text" id="chatInput" placeholder="Type a message..." style="width: 80%;">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    let lineChart, pieChart;

    // Function to update the line chart (assuming /api/alerts-over-time returns appropriate data)
    function updateLineChart() {
      fetch('/api/alerts-over-time')
        .then(response => response.json())
        .then(data => {
          const lineCtx = document.getElementById('lineChart').getContext('2d');
          if (lineChart) lineChart.destroy();
          lineChart = new Chart(lineCtx, {
            type: 'line',
            data: {
              labels: data.timestamps,
              datasets: [{
                label: "Alerts Over Time",
                data: data.alerts,
                fill: false,
                borderColor: 'red'
              }]
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true } }
            }
          });
        })
        .catch(error => console.error("Error fetching line chart data:", error));
    }

    // Function to update the pie chart using /api/severity-breakdown endpoint
    function updatePieChart() {
      fetch('/api/severity-breakdown')
        .then(response => response.json())
        .then(data => {
          console.log("Pie chart data received:", data); // Debug: log data to console

          // Define a legend mapping from descriptive string to number and color.
          const legendMapping = {
            "Not Suspicious": { number: "1", color: "green" },
            "Potentially Suspicious": { number: "2", color: "orange" },
            "Malicious Traffic": { number: "3", color: "red" }
          };

          // Transform the labels to include the numeric code
          const transformedLabels = data.labels.map(label => {
            if (legendMapping[label]) {
              return label + " (" + legendMapping[label].number + ")";
            }
            return label;
          });
          // Create background colors based on the legend mapping
          const backgroundColors = data.labels.map(label => {
            if (legendMapping[label]) {
              return legendMapping[label].color;
            }
            return '#CCCCCC'; // default color if label not found in legendMapping
          });

          const pieCtx = document.getElementById('pieChart').getContext('2d');
          if (pieChart) pieChart.destroy();
          pieChart = new Chart(pieCtx, {
            type: 'pie',
            data: {
              labels: transformedLabels,
              datasets: [{
                data: data.percentages,
                backgroundColor: backgroundColors,
                borderColor: '#fff',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        })
        .catch(error => console.error("Error fetching pie chart data:", error));
    }

    // Function to send a chat message to the backend
    function sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value;
      if (message.trim() === "") return;
      const chatbox = document.getElementById("chatbox");
      chatbox.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
      input.value = "";
      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
      })
      .then(response => response.json())
      .then(data => {
        chatbox.innerHTML += `<div><strong>Rasa:</strong> ${data.response}</div>`;
        chatbox.scrollTop = chatbox.scrollHeight;
      })
      .catch(error => console.error("Error sending chat message:", error));
    }

    // Establish a socket connection for real-time updates
    const socket = io();
    socket.on("update_charts", function() {
      updateLineChart();
      updatePieChart();
    });

    // Initial chart load
    updateLineChart();
    updatePieChart();
  </script>
</body>
</html>
